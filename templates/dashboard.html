{% extends "base.html" %}

{% block content %}
{% include 'navbar.html' %}

<div class="min-h-screen bg-gradient-to-r from-blue-50 to-blue-100 p-6">
    <div class="bg-white p-4 rounded-lg shadow-lg flex justify-between items-center">
        <h1 class="text-3xl font-extrabold text-gray-800 flex items-center gap-2">
            ğŸ“ƒ Dashboard
        </h1>

        <form method="GET" action="{{ url_for('inventory.dashboard') }}" class="flex items-center">
            <input type="text" name="search" placeholder="ğŸ” Search stock..." value="{{ search_query or '' }}"
                class="border border-gray-300 text-black rounded-l-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-r-md hover:bg-blue-600">Search</button>
        </form>
    </div>

    {% if inward_stock %}
    <div class="mt-6 bg-white p-4 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold text-gray-700 mb-3">ğŸ›’ Stock Items</h2>
        <div class="overflow-x-auto">
            <table class="w-full border-collapse border border-gray-200">
                <thead class="bg-gradient-to-r from-blue-400 to-blue-600 text-white">
                    <tr>
                        <th class="border p-3">ğŸ“Œ Item Name</th>
                        <th class="border p-3">ğŸ”¢ Quantity</th>
                        <th class="border p-3">ğŸ’² Purchase Rate</th>
                        <th class="border p-3">ğŸ’¸ Sale Rate</th>
                        <th class="border p-3">âš ï¸ Status</th>
                        <th class="border p-3">ğŸ› ï¸ Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in inward_stock %}
                    <tr class="text-gray-800 hover:bg-gray-100">
                        <td class="border p-3">{{ item.product_name }}</td>
                        <td class="border p-3">{{ item.quantity }}</td>
                        <td class="border p-3">â‚¹{{ "%.2f"|format(item.rate) }}</td>
                        <td class="border p-3">â‚¹{{ "%.2f"|format(item.price) }}</td>
                        <td class="border p-3 font-bold {% if item.quantity == 0 %} text-red-600 animate-pulse {% else %} text-green-600 {% endif %}">
                            {% if item.quantity == 0 %} âŒ Out of Stock {% else %} âœ… In Stock {% endif %}
                        </td>
                        <td class="border p-3 flex flex-col gap-2 md:flex-row md:items-center">
                            <button onclick="handleStockUpdate('{{ item._id }}', '{{ item.product_name }}', 'add')"
                                class="bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600">â• Add</button>
                            
                            <button onclick="handleStockUpdate('{{ item._id }}', '{{ item.product_name }}', 'delete')"
                                class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600">âŒ Delete</button>
                            
                            <button onclick="viewLogs('{{ item._id }}', '{{ item.product_name }}')"
                                class="bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600">ğŸ“œ Logs</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="mt-6 bg-white p-4 rounded-lg shadow-md text-center">
        <h1 class="text-lg text-red-600 font-bold">â— No Products Found for your search.</h1>
    </div>
    {% endif %}
</div>

<script>
    // Unified function for adding or deleting stock
    function handleStockUpdate(itemId, itemName, action) {
        const promptMessage = action === 'add'
            ? `â• How many units of '${itemName}' do you want to add?`
            : `âŒ How many units of '${itemName}' do you want to delete?`;

        const quantityStr = prompt(promptMessage);
        const quantity = parseInt(quantityStr);

        if (quantityStr !== null && !isNaN(quantity) && quantity > 0) {
            // For deletions, we send a negative number to the server
            const quantityChange = action === 'add' ? quantity : -quantity;
            
            // This function sends the data to the correct '/update_stock' route
            updateStockOnServer(itemId, quantityChange);
        } else if (quantityStr !== null) {
            alert("â— Please enter a valid number greater than 0.");
        }
    }

    function updateStockOnServer(itemId, quantityChange) {
        fetch(`/update_stock/${itemId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantity: quantityChange })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.status === 'success') {
                window.location.reload();
            }
        })
        .catch(error => {
            alert("âš ï¸ An error occurred.");
            console.error("Error:", error);
        });
    }
    
    // View Logs function
    function viewLogs(itemId, itemName) {
        fetch(`/view_logs/${itemId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === "success" && data.logs.length > 0) {
                    let message = `ğŸ“œ Logs for '${itemName}':\n\n`;
                    data.logs.forEach(log => {
                        message += `â€¢ ${log.action.toUpperCase()} by ${log.user} on ${log.timestamp} (Qty: ${log.quantity})\n`;
                    });
                    alert(message);
                } else {
                    alert(`â„¹ï¸ No logs found for '${itemName}'.`);
                }
            })
            .catch(error => {
                alert("â— Error retrieving logs.");
                console.error("Error:", error);
            });
    }
</script>
{% endblock %}